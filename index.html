<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>AVIS e-Fatura</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
body { background:#f3f4f6; font-family: Inter, system-ui, -apple-system, "Helvetica Neue", Arial; }
.invoice-container { position: relative; max-width:900px; margin:30px auto; background:#fff; border-radius:8px; padding:28px; box-shadow:0 10px 30px rgba(0,0,0,0.08); overflow:hidden; }
.watermark { position:absolute; left:50%; top:50%; transform:translate(-50%,-50%) rotate(-30deg); font-size:180px; font-weight:900; color:rgba(0,0,0,0.03); z-index:0; pointer-events:none; user-select:none; white-space:nowrap; letter-spacing:8px; }
.header-row { display:flex; align-items:center; justify-content:space-between; gap:12px; position:relative; z-index:1; flex-wrap:wrap; }
.logo-center img { height:78px; display:block; margin:0 auto; }
.logo-right img { height:44px; display:block; }
h1.title { text-align:center; color:#b91c1c; font-weight:700; margin:18px 0; }
.section { display:flex; gap:16px; margin-bottom:14px; flex-wrap:wrap; }
.card { background:#fafafa; border:1px solid #e6e6e6; padding:12px; border-radius:6px; flex:1 1 300px; font-size:13px; color:#1f2937; }
label { display:block; font-size:12px; color:#374151; margin-bottom:6px; font-weight:600; }
input, textarea, select { width:100%; padding:8px 10px; border:1px solid #d1d5db; border-radius:6px; background:#fff; font-size:13px; color:#111827; }
textarea { min-height:72px; resize:vertical; }
.btn { background:#b91c1c; color:#fff; padding:10px 16px; border-radius:6px; font-weight:700; border:none; cursor:pointer; }
.btn:hover { background:#991b1b; }
.note { font-size:11px; color:#6b7280; margin-top:14px; text-align:center; }
@media print { .btn { display:none; } }
</style>
</head>
<body>
<div class="invoice-container" id="invoiceRoot">
  <div class="watermark">AVIS</div>

  <div class="header-row">
    <div class="text-sm text-gray-700">
      <div>Fatura Tarihi: <span id="faturaTarih">--</span></div>
      <div>Seri No: <strong id="faturaSeri">AVS2025 / 00001</strong></div>
    </div>
    <div class="logo-center">
      <img id="logo2" src="logo2.jpg" alt="Avis2 Logo" crossorigin="anonymous">
    </div>
    <div class="logo-right">
      <img id="logo1" src="logo.jpg" alt="Avis Logo" crossorigin="anonymous">
    </div>
  </div>

  <h1 class="title">AVIS RENT A CAR - eFATURA</h1>

  <form id="efForm">
    <div class="section">
      <div class="card">
        <div style="font-weight:800; margin-bottom:8px;">Müşteri Bilgileri</div>
        <label>Ad Soyad</label><input name="adSoyad" type="text" id="adSoyad">
        <label>TC / Vergi No</label><input name="tc" type="text" id="tc">
        <label>Telefon</label><input name="tel" type="text" id="tel" placeholder="+90 5xx xxx xxxx">
        <label>E-posta</label><input name="email" type="text" id="email">
        <label>Adres</label><textarea name="adres" id="adres"></textarea>
      </div>

      <div class="card">
        <div style="font-weight:800; margin-bottom:8px;">Araç Bilgileri</div>
        <label>Marka</label><input name="marka" type="text" id="marka">
        <label>Model</label><input name="model" type="text" id="model">
        <label>Plaka</label><input name="plaka" type="text" id="plaka">
        <label>Yakıt / Vites</label><input name="yakit" type="text" id="yakit">
        <label>Ek Bilgi</label><textarea name="ek" id="ek"></textarea>
      </div>
    </div>

    <div class="section">
      <div class="card">
        <div style="font-weight:800; margin-bottom:8px;">Kiralama Bilgileri</div>
        <label>Başlangıç Tarihi</label><input name="baslangic" id="baslangic" type="datetime-local">
        <label>Bitiş Tarihi</label><input name="bitis" id="bitis" type="datetime-local">
        <label>Gün Sayısı</label><input name="gun" id="gun" type="number" readonly>
        <label>Teslimat Türü</label>
        <select name="teslimat" id="teslimat">
          <option value="Ofisten Teslim">Ofisten Teslim</option>
          <option value="Adrese Teslim">Adrese Teslim</option>
          <option value="Vale">Vale</option>
        </select>
        <label>Ödeme Yöntemi</label>
        <select name="odeme" id="odeme">
          <option value="Havale/EFT" selected>Havale / EFT</option>
          <option value="Kredi Kartı">Kredi Kartı</option>
          <option value="Nakit">Nakit</option>
        </select>
      </div>

      <div class="card">
        <div style="font-weight:800; margin-bottom:8px;">Fiyat Bilgileri</div>
        <label>Günlük Ücret (₺)</label><input name="gunluk" id="gunluk" type="number" step="0.01">
        <label>KDV Oranı (%)</label><input name="kdv" id="kdv" type="number" value="18" step="0.01">
        <label>Depozito (₺)</label><input name="depozito" id="depozito" type="number" step="0.01">
        <label>Toplam (₺)</label><input name="toplam" id="toplam" type="number" readonly>
      </div>
    </div>

    <div style="text-align:center; margin-top:14px;">
      <button type="button" class="btn" id="savePdfBtn">PDF Olarak Kaydet</button>
    </div>
  </form>

  <p class="note">Bu belge 509 Sıra Nolu VUK Genel Tebliği’ne göre e-Fatura niteliğindedir.</p>
</div>

<script>
function pad(num, size){let s="00000"+num;return s.substr(s.length-size);}
function readCounter(){return parseInt(localStorage.getItem('avis_serial_counter')||'0',10);}
function writeCounter(n){localStorage.setItem('avis_serial_counter',String(n));}
function consumeNext(){const cur=readCounter();const next=cur?cur+1:1;writeCounter(next);return next;}
function setHeaderNow(){
  const now=new Date();
  document.getElementById('faturaTarih').textContent=now.toLocaleString('tr-TR');
  document.getElementById('faturaSeri').textContent='AVS2025 / '+pad(readCounter()+1,5);
}
setHeaderNow();

async function toDataURL(url) {
  const response = await fetch(url, { mode: 'cors' });
  const blob = await response.blob();
  return new Promise((resolve) => {
    const reader = new FileReader();
    reader.onloadend = () => resolve(reader.result);
    reader.readAsDataURL(blob);
  });
}

document.getElementById('savePdfBtn').addEventListener('click', async ()=>{
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF('p', 'pt', 'a4');
  const element = document.getElementById('invoiceRoot');

  // logoları base64'e dönüştür ve src'yi değiştir
  const logo1 = document.getElementById('logo1');
  const logo2 = document.getElementById('logo2');
  try {
    if (logo1 && logo1.src && !logo1.src.startsWith('data:')) logo1.src = await toDataURL('logo.jpg');
    if (logo2 && logo2.src && !logo2.src.startsWith('data:')) logo2.src = await toDataURL('logo2.jpg');
  } catch (err) {
    console.warn('Logo dönüştürme hatası:', err);
  }

  await pdf.html(element, {
    margin: [20, 20, 20, 20],
    autoPaging: 'text',
    html2canvas: { scale: 0.8, useCORS: true },
    callback: function (doc) {
      const serial = document.getElementById('faturaSeri').textContent.replace(/\s+/g,'_');
      doc.save(`Avis_EFatura_${serial}.pdf`);
    }
  });
});
</script>
</body>
</html>
