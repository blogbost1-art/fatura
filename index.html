<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>AVIS e-Fatura</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
body { background:#f3f4f6; font-family: Inter, system-ui, -apple-system, "Helvetica Neue", Arial; }
.invoice-container { position: relative; max-width:900px; margin:30px auto; background:#fff; border-radius:8px; padding:28px; box-shadow:0 10px 30px rgba(0,0,0,0.08); overflow:hidden; }
.watermark { position:absolute; left:50%; top:50%; transform:translate(-50%,-50%) rotate(-30deg); font-size:180px; font-weight:900; color:rgba(0,0,0,0.03); z-index:0; pointer-events:none; user-select:none; white-space:nowrap; letter-spacing:8px; }
.header-row { display:flex; align-items:center; justify-content:space-between; gap:12px; position:relative; z-index:1; flex-wrap:wrap; }
.logo-center img { height:78px; display:block; margin:0 auto; }
.logo-right img { height:44px; display:block; }
h1.title { text-align:center; color:#b91c1c; font-weight:700; margin:18px 0; }
.section { display:flex; gap:16px; margin-bottom:14px; flex-wrap:wrap; }
.card { background:#fafafa; border:1px solid #e6e6e6; padding:12px; border-radius:6px; flex:1 1 300px; font-size:13px; color:#1f2937; }
label { display:block; font-size:12px; color:#374151; margin-bottom:6px; font-weight:600; }
input, textarea, select { width:100%; padding:8px 10px; border:1px solid #d1d5db; border-radius:6px; background:#fff; font-size:13px; color:#111827; }
textarea { min-height:72px; resize:vertical; }
.btn { background:#b91c1c; color:#fff; padding:10px 16px; border-radius:6px; font-weight:700; border:none; cursor:pointer; }
.btn:hover { background:#991b1b; }
.note { font-size:11px; color:#6b7280; margin-top:14px; text-align:center; }
@media print { .btn { display:none; } }
</style>
</head>
<body>
<div class="invoice-container" id="invoiceRoot">
  <div class="watermark">AVIS</div>

  <div class="header-row">
    <div class="text-sm text-gray-700">
      <div>Fatura Tarihi: <span id="faturaTarih">--</span></div>
      <div>Seri No: <strong id="faturaSeri">AVS2025 / 00001</strong></div>
    </div>

    <div class="logo-center"><img src="avis2.jpg" alt="Avis2 Logo" crossorigin="anonymous"></div>
    <div class="logo-right"><img src="avis.jpg" alt="Avis Logo" crossorigin="anonymous"></div>
  </div>

  <h1 class="title">AVIS RENT A CAR - eFATURA</h1>

  <form id="efForm">
    <div class="section">
      <div class="card">
        <div style="font-weight:800; margin-bottom:8px;">Müşteri Bilgileri</div>
        <label>Ad Soyad</label><input name="adSoyad" type="text">
        <label>TC / Vergi No</label><input name="tc" type="text">
        <label>Telefon</label><input name="tel" type="text" placeholder="+90 5xx xxx xxxx">
        <label>E-posta</label><input name="email" type="text">
        <label>Adres</label><textarea name="adres"></textarea>
      </div>

      <div class="card">
        <div style="font-weight:800; margin-bottom:8px;">Araç Bilgileri</div>
        <label>Marka</label><input name="marka" type="text">
        <label>Model</label><input name="model" type="text">
        <label>Plaka</label><input name="plaka" type="text">
        <label>Yakıt / Vites</label><input name="yakit" type="text">
        <label>Ek Bilgi</label><textarea name="ek"></textarea>
      </div>
    </div>

    <div class="section">
      <div class="card">
        <div style="font-weight:800; margin-bottom:8px;">Kiralama Bilgileri</div>
        <label>Başlangıç Tarihi</label><input name="baslangic" id="baslangic" type="datetime-local">
        <label>Bitiş Tarihi</label><input name="bitis" id="bitis" type="datetime-local">
        <label>Gün Sayısı</label><input name="gun" id="gun" type="number" readonly>
        <label>Teslimat Türü</label>
        <select name="teslimat">
          <option value="Ofisten Teslim">Ofisten Teslim</option>
          <option value="Adrese Teslim">Adrese Teslim</option>
          <option value="Vale">Vale</option>
        </select>
        <label>Ödeme Yöntemi</label>
        <select name="odeme">
          <option value="Havale/EFT" selected>Havale / EFT</option>
          <option value="Kredi Kartı">Kredi Kartı</option>
          <option value="Nakit">Nakit</option>
        </select>
      </div>

      <div class="card">
        <div style="font-weight:800; margin-bottom:8px;">Fiyat Bilgileri</div>
        <label>Günlük Ücret (₺)</label><input name="gunluk" id="gunluk" type="number" step="0.01">
        <label>KDV Oranı (%)</label><input name="kdv" id="kdv" type="number" value="18" step="0.01">
        <label>Depozito (₺)</label><input name="depozito" id="depozito" type="number" step="0.01">
        <label>Toplam (₺)</label><input name="toplam" id="toplam" type="number" readonly>
      </div>
    </div>

    <div style="text-align:center; margin-top:14px;">
      <button type="button" class="btn" id="savePdfBtn">PDF Olarak Kaydet</button>
    </div>
  </form>

  <p class="note">Bu belge 509 Sıra Nolu VUK Genel Tebliği’ne göre e-Fatura niteliğindedir.</p>
</div>

<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
function pad(num, size){let s="00000"+num;return s.substr(s.length-size);}
function readCounter(){return parseInt(localStorage.getItem('avis_serial_counter')||'0',10);}
function writeCounter(n){localStorage.setItem('avis_serial_counter',String(n));}
function consumeNext(){const cur=readCounter();const next=cur?cur+1:1;writeCounter(next);return next;}
function setHeaderNow(){const now=new Date();document.getElementById('faturaTarih').textContent=now.toLocaleString('tr-TR');document.getElementById('faturaSeri').textContent='AVS2025 / '+pad(readCounter()+1,5);}
setHeaderNow();

function hesaplaGunVeTutar(){
  const bas=document.getElementById("baslangic").value;
  const bit=document.getElementById("bitis").value;
  const gunluk=parseFloat(document.getElementById("gunluk").value)||0;
  const kdv=parseFloat(document.getElementById("kdv").value)||0;
  const depozito=parseFloat(document.getElementById("depozito").value)||0;
  if(bas && bit){
    const start=new Date(bas);
    const end=new Date(bit);
    const fark=(end-start)/(1000*60*60*24);
    const gun=Math.max(1,Math.ceil(fark));
    document.getElementById("gun").value=gun;
    const kiraBedeli=gun*gunluk;
    const kdvTutar=kiraBedeli*(kdv/100);
    const toplam=kiraBedeli+kdvTutar+depozito;
    document.getElementById("toplam").value=toplam.toFixed(2);
  }
}
["baslangic","bitis","gunluk","kdv","depozito"].forEach(id=>{
  document.getElementById(id).addEventListener("change",hesaplaGunVeTutar);
});

async function generatePdf(node, filename){
  const { jsPDF } = window.jspdf;
  const btn=node.querySelector(".btn");
  if(btn) btn.style.display="none";

  const canvas=await html2canvas(node,{scale:2,useCORS:true,allowTaint:true,backgroundColor:'#fff'});
  const imgData=canvas.toDataURL('image/png');
  const pdf=new jsPDF('p','pt','a4');
  const pageWidth=pdf.internal.pageSize.getWidth();
  const imgHeight=(canvas.height*pageWidth)/canvas.width;
  pdf.addImage(imgData,'PNG',0,0,pageWidth,imgHeight);
  pdf.save(filename);
  if(btn) btn.style.display="inline-block";
}

document.getElementById('savePdfBtn').addEventListener('click', async ()=>{
  const nextNum=consumeNext();
  const serial='AVS2025 / '+pad(nextNum,5);
  document.getElementById('faturaSeri').textContent=serial;
  document.getElementById('faturaTarih').textContent=new Date().toLocaleString('tr-TR');
  await generatePdf(document.getElementById('invoiceRoot'),
  `Avis_EFatura_${serial.replace(/\s+/g,'_').replace(/\//g,'-')}.pdf`);
});
</script>
</body>
</html>
